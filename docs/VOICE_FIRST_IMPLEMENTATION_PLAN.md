# 音声メイン会話習得機能 実装計画

## 概要

音声中心の英会話習得機能を実装するための詳細な実装計画です。
既存の例文ベースの学習システムを拡張し、会話形式の音声学習に対応します。

## 実装フェーズ

### Phase 1: データベース・モデル実装（1週間）

#### 1.1 データベースマイグレーション
- [x] `conversations`テーブル作成
- [x] `conversation_utterances`テーブル作成
- [x] `voice_playback_history`テーブル作成
- [x] 既存テーブルの拡張（`sentences`, `scenarios`）

#### 1.2 モデル実装
- [ ] `Conversation`モデル作成
- [ ] `ConversationUtterance`モデル作成
- [ ] `VoicePlaybackHistory`モデル作成
- [ ] `Sentence`モデルの拡張（会話対応）

#### 1.3 サービス実装
- [ ] `ConversationService`作成
- [ ] `VoicePlaybackService`作成

### Phase 2: UI/UX実装（2-3週間）

#### 2.1 会話学習画面の基本実装
- [ ] `ConversationStudyScreen`作成
- [ ] シチュエーション画像表示
- [ ] 音声再生ボタン（初期状態のみ表示）
- [ ] テキスト表示ボタン（音声再生後に有効化）

#### 2.2 会話ラリー表示
- [ ] 発話者の表示（A/B/C役）
- [ ] 会話の順次表示
- [ ] 現在のターン表示

#### 2.3 音声再生履歴管理
- [ ] セッションごとの履歴記録
- [ ] テキスト表示ボタンの有効化判定
- [ ] セッション切り替え時のリセット

### Phase 3: 音声認識統合（2-3週間）

#### 3.1 発話判定機能
- [ ] `speech_to_text`の統合強化
- [ ] 発話判定ロジック（類似度計算）
- [ ] 判定結果のフィードバック

#### 3.2 ロールプレイングモード
- [ ] 役割選択UI（A役のみ / B役のみ / 両方の役）
- [ ] 自分のターンでの録音/発話
- [ ] **ユーザーが発話したタイミングで、もう一方の役（B or A）のTTSを再生**
- [ ] 会話の進行管理

#### 3.3 全役割モード
- [ ] 会話全体を順番に発話
- [ ] 進捗管理

#### 3.4 会話全体を聞く（聞き流し）
- [x] 1発話ずつ順番にTTS再生（awaitSpeakCompletion により発話完了を待機）
- [x] 再生中の発話へスクロール

### Phase 4: シチュエーションコンテンツ作成（継続）

#### 4.1 学生コース会話作成
- [ ] Week 1-2: 挨拶
- [ ] Week 3-4: 自己紹介
- [ ] Week 5-6: 道案内
- [ ] Week 7-8: 空港
- [ ] Week 9-10: ホテル
- [ ] Week 11-12: カフェ&レストラン
- [ ] Week 13-14: ショッピング
- [ ] Week 15-16: 交通機関
- [ ] Week 17-18: 銀行口座開設
- [ ] Week 19-20: 郵便局・宅急便
- [ ] Week 21-22: 病院
- [ ] Week 23-24: カスタム

#### 4.2 ビジネスコース会話作成
- [ ] Week 1-2: 挨拶
- [ ] Week 3-4: 自己紹介
- [ ] Week 5-6: 道案内
- [ ] Week 7-8: 空港
- [ ] Week 9-10: ホテル
- [ ] Week 11-12: カフェ&レストラン
- [ ] Week 13-14: ショッピング
- [ ] Week 15-16: 交通機関
- [ ] Week 17-18: ビジネスメール
- [ ] Week 19-20: ビジネスプレゼンテーション①
- [ ] Week 21-22: ビジネスプレゼンテーション②
- [ ] Week 23-24: カスタム

## 技術的な考慮事項

### 1. 後方互換性
- 既存の`sentences`テーブルはそのまま維持
- `conversation_id`がnullの場合は従来通り動作
- 既存の学習モードも継続利用可能

### 2. 音声再生履歴の管理
- セッションIDベースで管理
- 同じ会話でもセッションが変わればリセット
- テキスト表示ボタンの有効化はセッション内でのみ有効

### 3. パフォーマンス
- 会話データのキャッシュ
- 音声ファイルの事前ダウンロード（オプション）
- インデックスの最適化

## 実装上の注意点

### 1. テキスト表示条件の実装
```dart
// 疑似コード
bool canShowText() {
  // セッション内で1回以上音声再生されたかチェック
  final hasPlayed = voicePlaybackHistory.any(
    (h) => h.sessionId == currentSessionId && 
           h.utteranceId == currentUtteranceId
  );
  return hasPlayed;
}
```

### 2. セッション管理
- 会話開始時に新しいセッションIDを生成
- 会話終了または画面遷移時にセッションを終了
- セッション終了時にテキスト表示状態をリセット

### 3. 音声認識の精度
- 発話判定は「補助機能」として扱う
- 完全一致ではなく、類似度ベースの判定
- 判定失敗時も学習を継続できるようにする

## 既存機能との統合

### 1. シナリオ機能との統合
- シナリオ内に会話形式のステップを追加可能
- 会話と例文を混在させたシナリオも対応

### 2. 進捗管理との統合
- 会話単位での進捗管理
- 発話ごとの進捗も記録可能

### 3. バッジ/称号との統合
- 会話完了数に基づくバッジ
- 音声のみで完了した会話数に基づくバッジ

## 受け入れ条件

1. 初期状態でテキストが非表示である
2. 音声を1回以上流すとテキスト表示ボタンが有効化される
3. セッションが変わるとテキスト表示状態がリセットされる
4. 会話形式で音声学習ができる
5. 既存の例文学習も継続利用できる
